<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>trootski | What I wished I'd known before working with Apache Camel</title><meta name=description content="A list of some the things that I wish I had known at the beginning of a recent project working with Apache Camel"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.111.3"><meta name=ROBOTS content="INDEX, FOLLOW"><meta property="og:title" content="What I wished I'd known before working with Apache Camel"><meta property="og:description" content="A list of some the things that I wish I had known at the beginning of a recent project working with Apache Camel"><meta property="og:type" content="article"><meta property="og:url" content="https://trootski.github.io/post/2021/12/what-i-wished-id-known-before-working-with-apache-camel/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-12-12T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-12T00:00:00+00:00"><link href=/css/styles.css rel=stylesheet><link rel=canonical href=https://trootski.github.io/post/2021/12/what-i-wished-id-known-before-working-with-apache-camel/><script type=application/javascript src=/main.js></script>
<link rel=icon type=image/png href=/images/favicon.png></head><body><nav class="navbar fixed-top navbar-expand-sm navbar-dark bg-primary"><div class=container><a href=/ class=navbar-brand>trootski</a>
<button class="navbar-toggle d-xs-block d-md-none" type=button data-toggle=toggle data-target=#mainNavAltContent aria-controls=mainNavAltContent aria-expanded=false aria-label="Toggle Navigation">
<span class=navbar-toggler-icon></span></button><div class="navbar-collapse collapse" id=mainNavAltContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/ title="Blog page">Blog</a></li><li class=nav-item><a class=nav-link href=/work title="Work page">Work</a></li><li class=nav-item><a class=nav-link href=/about title="About page">About</a></li></ul><ul class="navbar-nav d-flex flex-row"><li class=nav-item><a href=https://twitter.com/trootski target=_blank class="link-transition twitter" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></li><li class=nav-item><a href=https://www.linkedin.com/in/troot1/ target=_blank class="link-transition linkedin" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></li><li class=nav-item><a href=https://github.com/trootski target=_blank class="link-transition github" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></a></li></ul></div></div></nav><div class=container><div class=row><div class="col-12 col-md-3" role=navigation><div class="sidebar-holder sticky-top"><div class=sidebar-inner><div class=lead><img src=/images/avatar.jpeg class="img-thumbnail d-block framed mb-auto"><p>Blog for trootski. All opinions expressed are dubious and his own.</p></div><button class="btn btn-dark sidebar-toggle d-xs-block d-md-none" type=button data-toggle=collapse data-target=#collapseMore aria-expanded=false aria-controls=collapseMore>More</button><div class="d-none d-sm-block" id=sidebarCollapse><div class=most-recent><h3>Most Recent</h3><ul><li><a href=/post/2025/09/lovin-miniflux/>Lovin Miniflux</a></li><li><a href=/post/2024/11/longest-linux-run-yet/>A year of the Linux desktop</a></li><li><a href=/post/2021/12/what-i-wished-id-known-before-working-with-apache-camel/>What I wished I'd known before working with Apache Camel</a></li></ul></div><div class=tag-list><h3>Tags</h3><div class="tags btn-group"><a href=/tags/actionscript class="badge badge-primary" title="All pages with tag actionscript - 5 articles">actionscript (5)</a>
<a href=/tags/agile class="badge badge-primary" title="All pages with tag agile - 1 articles">agile (1)</a>
<a href=/tags/hardware class="badge badge-primary" title="All pages with tag hardware - 7 articles">hardware (7)</a>
<a href=/tags/java class="badge badge-primary" title="All pages with tag java - 3 articles">java (3)</a>
<a href=/tags/javascript class="badge badge-primary" title="All pages with tag javascript - 2 articles">javascript (2)</a>
<a href=/tags/linux class="badge badge-primary" title="All pages with tag linux - 5 articles">linux (5)</a>
<a href=/tags/personal class="badge badge-primary" title="All pages with tag personal - 9 articles">personal (9)</a>
<a href=/tags/php class="badge badge-primary" title="All pages with tag php - 2 articles">php (2)</a>
<a href=/tags/play class="badge badge-primary" title="All pages with tag play - 8 articles">play (8)</a>
<a href=/tags/python class="badge badge-primary" title="All pages with tag python - 2 articles">python (2)</a>
<a href=/tags/software-engineering class="badge badge-primary" title="All pages with tag software-engineering - 17 articles">software-engineering (17)</a>
<a href=/tags/spring-boot class="badge badge-primary" title="All pages with tag spring-boot - 3 articles">spring-boot (3)</a>
<a href=/tags/testing class="badge badge-primary" title="All pages with tag testing - 2 articles">testing (2)</a>
<a href=/tags/tooling class="badge badge-primary" title="All pages with tag tooling - 16 articles">tooling (16)</a>
<a href=/tags/work class="badge badge-primary" title="All pages with tag work - 16 articles">work (16)</a></div></div></div></div></div></div><main class="col-12 col-md-8" role=main><article class="card border-0"><a href=/post/2021/12/what-i-wished-id-known-before-working-with-apache-camel/apache-camel-logo.png><img src=/post/2021/12/what-i-wished-id-known-before-working-with-apache-camel/apache-camel-logo_hu6e260bad5f3b630d2640c1a5bfb0259b_47550_730x547_fit_q97_box_3.png class=card-img-top alt="Cover image from What I wished I'd known before working with Apache Camel"></a><div class=card-body><h3 class=card-title>What I wished I'd known before working with Apache Camel</h3><small class=text-muted>December 12, 2021</small><div class=card-text><p>I recently started working on an Apache Camel project at work. The application in question would, I imagine, have been an atypical use case for Apache Camel. It was used primarily for the DSL definition of a series of RESTful calls to dependent services. These routes were leveraged by the application’s controller layer.</p><p>My approach at the beginning and my approach by the end were pretty different.</p><p>Unless stated the below are examples are taken from the <a href=https://github.com/trootski/apache-camel-wish-id-known>Apache Camel Wish I&rsquo;d Known</a> sample code on GitHub.</p><h2 id=unit-vs-integration-tests-of-routes>Unit vs Integration tests of routes </h2><p>It took me some time at first to decide on the scoping of tests when working with Apache Camel. I generally err towards
the <a href=https://softwareengineering.stackexchange.com/questions/123627/what-are-the-london-and-chicago-schools-of-tdd>London/Interaction style</a> TDD testing. When working with Spring / Apache Camel I find this approach difficult to translate at times. In the context of these examples, what are we testing; the route DSL definition, or the results of progression through the route.</p><p>Lets take the following example from a Java DSL route definition:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>from<span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span>QUEUE_BOND_MOVIE_LISTENER<span style=color:#f92672>,</span> topic<span style=color:#f92672>,</span> brokers<span style=color:#f92672>,</span> groupId<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Message received from Kafka : ${body}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    on the topic ${headers[kafka.TOPIC]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    on the partition ${headers[kafka.PARTITION]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    with the offset ${headers[kafka.OFFSET]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    with the key ${headers[kafka.KEY]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>unmarshal</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>json</span><span style=color:#f92672>(</span>JsonLibrary<span style=color:#f92672>.</span><span style=color:#a6e22e>Jackson</span><span style=color:#f92672>,</span> BondMovieRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>enrich</span><span style=color:#f92672>(</span>GET_MOVIE_DETAILS_ROUTE<span style=color:#f92672>,</span> detailsAggregationStrategy<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>PERSIST_AGGREGATE_MOVIE_DETAIL_ROUTE<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>constant<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>));</span>
</span></span></code></pre></div><p><em>Note: this example is taken from a <a href=https://github.com/trootski/bond/blob/fb5683a59d50de0fb9b716fd84be60b0676f6f7f/process-queue-spring-camel-kafka/src/main/java/org/troot/bondmovieapi/route/BondMovieRouteBuilder.java#L55>sample project</a>.</em></p><h3 id=_what-should-be-tested_><em>What should be tested?</em></h3><h4 id=side-effects->Side Effects ❌</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Message received from Kafka : ${body}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    on the topic ${headers[kafka.TOPIC]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    on the partition ${headers[kafka.PARTITION]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    with the offset ${headers[kafka.OFFSET]}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>(</span>INFO<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;    with the key ${headers[kafka.KEY]}&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>I would consider the log messages to be a side effect. I wouldn&rsquo;t recommend verification of calling them as they have no
concrete effect on the execution of the route.</p><h4 id=3rd-party-libraries->3rd Party Libraries ✅</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>unmarshal</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>json</span><span style=color:#f92672>(</span>JsonLibrary<span style=color:#f92672>.</span><span style=color:#a6e22e>Jackson</span><span style=color:#f92672>,</span> BondMovieRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>These methods will be invoked in Unit and Integration tests. They will expect to have relavent exchange properties set.
In the example above the exchange is expected to have a <em><em>BondMovieRequest</em></em> as the in body. I would recommend both Unit and Integration testing this. There are probably many pros and cons, but one fact is that can be difficult to mock 3rd party libraries. As a rule of thumb I do not think it is desirable to mock 3rd party libraries anyway.</p><h4 id=local-components>Local Components</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>enrich</span><span style=color:#f92672>(</span>GET_MOVIE_DETAILS_ROUTE<span style=color:#f92672>,</span> detailsAggregationStrategy<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>This line I would find a bit more problematic. With regard to a Unit test, testing this would in effect be testing the
DetailsAggregationStrategy. That would imply duplication of testing. However, if I mock it, none of the following tests
will have the values you might expect them to have. I made the decsion to mock; bean, processor, enrich, and other EIP
components with local processing for the route Unit tests.</p><p>With regard to an Integration test it is more straightforward, we are testing that this component (DetailsAggregationStrategy) works as expected with the other components of the route.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>PERSIST_AGGREGATE_MOVIE_DETAIL_ROUTE<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>constant<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>));</span>
</span></span></code></pre></div><p>Now, we are obliged to inject data intermittently into our route in order that it does not fail. This is because any
processors that we would expect to be transforming our exchange are not being called.</p><h2 id=using-ids-for-everything-that-is-an-external-call-to-make-for-easier-testing>Using ids for everything that is an external call, to make for easier testing</h2><h3 id=routeid>routeId</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>from<span style=color:#f92672>(</span>READ_ROBOTS_JSON_ROUTE<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>routeId</span><span style=color:#f92672>(</span>READ_ROBOTS_JSON_ROUTE_ID<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Assigning a <code>routeId</code> to our route allows us to easily retrieve a reference to our route when creating our unit tests as
can be seen below. Once we have a reference to the route we can then modify it as required for mocking purposes. An
example of this can be seen below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRouteDefinition</span><span style=color:#f92672>(</span>READ_ROBOTS_JSON_ROUTE_ID<span style=color:#f92672>).</span><span style=color:#a6e22e>adviceWith</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> AdviceWithRouteBuilder<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>});</span>
</span></span></code></pre></div><p>Using the above code we can use the <code>weaveBy*</code> set of methods to modify the route at run time.</p><p>Another point to note about the <code>routeId</code> is that the value that is used here will also be the prefix that is used when
log messages are output. Therefore I would recommend using a properly namespaced value so that your logback rules work
as expected when changing log levels for certain paths.</p><h3 id=id>id</h3><p>Ids can also be set on particular elements of a route. Used in conjunction with the <code>getRouteDefinition</code> method above
this allows us to directly splice mock elements into our route as required. The following page has more details about
the various weave methods <a href=https://people.apache.org/~dkulp/camel/advicewith.html>https://people.apache.org/~dkulp/camel/advicewith.html</a>. I have found that <code>weaveById</code> is the most reliable. This is because when under test a modified Apache Camel route can become difficult to work with. Methods like <code>weaveAddFirst</code> and <code>weaveAddLast</code> which assume the route is still in its initial state can become unpredicatable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>enrich</span><span style=color:#f92672>(</span>GET_ROBOT_QUOTES_ROUTE<span style=color:#f92672>,</span> quoteAggregationStrategy<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(</span>READ_ROBOTS_JSON_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> GET_ROBOT_QUOTES_ENDPOINT_ID<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>The effect of the code below will be to replace the enrich call with a mock endpoint. Assertions can then be placed on
the MockEndpoint. Additionally callbacks can be configured on the mock endpoint which allow us to modify the test date
during the test. Lastly, it also allows us to simulate some failure scenarios that can at times be difficult to
simulate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRouteDefinition</span><span style=color:#f92672>(</span>READ_ROBOTS_JSON_ROUTE_ID<span style=color:#f92672>).</span><span style=color:#a6e22e>adviceWith</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> AdviceWithRouteBuilder<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                weaveById<span style=color:#f92672>(</span>READ_ROBOTS_JSON_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> GET_ROBOT_QUOTES_ENDPOINT_ID<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>mockGetQuoteEndpoint<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span></code></pre></div><h2 id=properly-leverage-the-mockendpoint-system-and-using-expect-methods-and-assertissatisfied>Properly leverage the MockEndpoint system and using expect methods and assertIsSatisfied</h2><p>Once an element of a route is mocked, the mock endpoint system can be leveraged to perform a lot of useful tasks. First
we need to create our mock endpoint.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>MockEndpoint mockGetQuoteEndpoint <span style=color:#f92672>=</span> getMockEndpoint<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mock:direct://getRobotQuotes&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>After we have replaced an element of the route with our mock endpoint we can create some expectations. Some example of
what we can assert are;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        mockFuturamaApiEndpoint<span style=color:#f92672>.</span><span style=color:#a6e22e>expectedMessagesMatches</span><span style=color:#f92672>(</span>exchange <span style=color:#f92672>-&gt;</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getIn</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        mockFuturamaApiEndpoint<span style=color:#f92672>.</span><span style=color:#a6e22e>expectedHeaderReceived</span><span style=color:#f92672>(</span>HTTP_PATH<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;/characters/mock-name&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>We can also modify all exchanges;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        mockFuturamaApiEndpoint<span style=color:#f92672>.</span><span style=color:#a6e22e>whenAnyExchangeReceived</span><span style=color:#f92672>(</span>exchange <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getIn</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;[{\&#34;quote\&#34;:\&#34;test quote\&#34;}]&#34;</span><span style=color:#f92672>));</span>
</span></span></code></pre></div><p>Or configure it so that a series of responses can be applied;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        mockFuturamaApiEndpoint<span style=color:#f92672>.</span><span style=color:#a6e22e>whenExchangeReceived</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> exchange <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getIn</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;[{\&#34;quote\&#34;:\&#34;test quote 1\&#34;}]&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        mockFuturamaApiEndpoint<span style=color:#f92672>.</span><span style=color:#a6e22e>whenExchangeReceived</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> exchange <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getIn</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;[{\&#34;quote\&#34;:\&#34;test quote 2\&#34;}]&#34;</span><span style=color:#f92672>));</span>
</span></span></code></pre></div><p>Finally, after we have made our test request on our route we can assert that all our configured expectations have been
satisfied.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        assertMockEndpointsSatisfied<span style=color:#f92672>();</span>
</span></span></code></pre></div><h2 id=embrace-eip-patterns>Embrace EIP patterns</h2><p>EIP (Enterprise Integration Patterns) is a series of patterns which can be applied to your solutions. They are the
patterns that have guided the base Java DSL components of Apache Camel. <a href=https://www.amazon.co.uk/Enterprise-Application-Architecture-Addison-Wesley-Signature/dp/0321127420>Patterns of Enterprise Application Architecture</a> is a highly recommended book which delves into each of the patterns. Apache Camel&rsquo;s own documentation on EIP patterns is also very good and can quickly familiarise you with the various patterns that are available.</p><p>There is also a standard icon set available for the patterns which can make it more convenient to create high level
diagrams for your routes. Below is an example that was produced in LucidChart</p><p><img src=./readRobotsJson.png alt="Read Robots JSON sample EIP diagram"></p><h2 id=abstract-the-transport-details>Abstract the transport details</h2><p>When coding in Spring Boot I tend to follow the three tier architecture of model/data, services, and controller. One of
the benefits of this is that once the objects have reached the service layer they are in a format that has been stripped
of any transport specific information. This could include HTTP headers, Kafka message headers, whatever the case may be.
I would recommend following the same pattern in Apache Camel and after each transport operation marshalling the data
back into a transport agnostic form more appropriate for the service layer. This makes it easier to refactor your routes
as the data types will be standardised.</p><h2 id=manage-your-types>Manage your types</h2><p>Directly related to the point regarding <a href=#abstract-the-transport-details>Abstract the transport details</a>, the point
here is to ensure that an appropriate value type exists such that the information required by your route is present.
This can also be accomplished by utilising <a href=https://camel.apache.org/components/3.7.x/eips/setProperty-eip.html>properties</a> however the more properties that are created the greater the complexity of the route. I would prefer as concise as possible a type which can then be mutated by the route components as required.</p><h2 id=difference-between-to-and-multicast-and-why-recipientlist-is-not-a-replacement>Difference between to and multicast, and why recipientList is not a replacement</h2><p>The <a href=https://camel.apache.org/components/3.7.x/eips/to-eip.html>to</a> EIP is used to send one instance of an Exchange to
a destination.</p><p>The <a href=https://camel.apache.org/components/3.13.x/eips/multicast-eip.html>multicast</a> EIP is used to send a copy of an
Exchange to each destination specified.</p><p>The <a href=https://camel.apache.org/components/3.13.x/eips/recipientList-eip.html>recipientList</a> EIP is used to send a copy
of an Exchange to a dynamically generated set of destinations.</p><p><a href=https://camel.apache.org/components/3.13.x/eips/recipientList-eip.html>recipientList</a> and <a href=https://camel.apache.org/components/3.13.x/eips/split-eip.html>split</a> are extended from multicast. I mention this specifically as I have seen recipientList used where multicast is probably the better fit.</p><h2 id=expose-as-much-as-possible-through-the-dsl>Expose as much as possible through the DSL</h2><p>This is another YMMV point, but I would suggest moving as much logic as possible into the route DSL. This makes the
routes more readable and means less traversal of the code to see what is happening. If the EIP patterns are properly
embraced there shouldn&rsquo;t be too many places where it is necassary to shift your logic into nameless processors.</p><h2 id=predicates-can-really-make-the-dsl-calls-obvious>Predicates can really make the DSL calls obvious</h2><p>To aid in <a href=#expose-as-much-as-possible-through-the-dsl>Exposing as much as possible through the DSL</a> leveraging the
<a href=https://camel.apache.org/manual/predicate.html>Predicate</a> type can make your choice and filter code more readable. While the <a href=https://camel.apache.org/components/3.13.x/languages/simple-language.html>Simple Expression Language</a> has some basic support for comparisons Predicates allow you to have more complex rules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Predicate isUserAvailable <span style=color:#f92672>=</span> exchange <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    User user <span style=color:#f92672>=</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getIn</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>(</span>User<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> user <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>isActive</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> user<span style=color:#f92672>.</span><span style=color:#a6e22e>isAvailable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>from<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;direct://processUser&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>choice</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>isUserAvailable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;direct://addUser&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>end</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>end</span><span style=color:#f92672>()</span>
</span></span></code></pre></div><h2 id=stoponexception-for-splits-can-save-unnecessary-hassle>stopOnException for splits can save unnecessary hassle</h2><p>Very specific piece of advice, but, the multicast based endpoint routers support a property called <code>stopOnException</code>.
This can be very useful if you are performing a parallel series of tasks that you want to fail early.</p><h2 id=split-http-parts-out-to-their-headers-it-makes-it-easer-to-test>Split HTTP parts out to their headers (it makes it easer to test)</h2><p>I worked a bit with the <a href=https://camel.apache.org/components/2.x/http4-component.html>HTTP4 component</a> recently and something that I don&rsquo;t think I fully appreciated was how to leverage the message headers. I had been attempting to too directly construct URLs. Using the supplied headers correctly however allows for easier testing than attempting to construct strings.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>HTTP_PATH<span style=color:#f92672>,</span> simple<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/characters/${body[0].name}&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>HTTP_METHOD<span style=color:#f92672>,</span> GET<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span>CONTENT_TYPE<span style=color:#f92672>,</span> constant<span style=color:#f92672>(</span>APPLICATION_JSON<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>constant<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>to</span><span style=color:#f92672>(</span>FUTURAMA_QUOTES_API_BASE_URL<span style=color:#f92672>)</span>
</span></span></code></pre></div></div><div class=card-footer><h5>Tags</h5><div class="tags btn-group" role=group aria-label="Tags list"><a href=/tags/java class="badge badge-primary">Java</a>
<a href=/tags/software-engineering class="badge badge-primary">Software Engineering</a>
<a href=/tags/spring-boot class="badge badge-primary">Spring Boot</a>
<a href=/tags/testing class="badge badge-primary">Testing</a></div></div></div></article><div><ul class="nav justify-content-between"><li class=nav-item><a class=nav-link href=/post/2021/01/bond-project/ title="Bond Project">Older</a></li><li class=nav-item><a class=nav-link href=/post/2024/11/longest-linux-run-yet/ title="A year of the Linux desktop">Newer</a></li></ul></div></main></div></div></body></html>